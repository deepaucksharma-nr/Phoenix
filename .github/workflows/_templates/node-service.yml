name: Node.js Service CI/CD
# Created by Abhinav as part of CI/CD Pipeline Standardization

on:
  workflow_call:
    inputs:
      service-name:
        required: true
        type: string
        description: "Name of the service"
      working-directory:
        required: true
        type: string
        description: "Directory containing the service code"
      node-version:
        required: false
        type: string
        default: '18'
        description: "Node.js version to use"
      package-manager:
        required: false
        type: string
        default: 'npm'
        description: "Package manager to use (npm, yarn, pnpm)"
      run-e2e-tests:
        required: false
        type: boolean
        default: true
        description: "Whether to run E2E tests"
      deploy-environments:
        required: false
        type: string
        default: 'development'
        description: "Comma-separated list of environments to deploy to"
      security-scan-level:
        required: false
        type: string
        default: 'medium'
        description: "Security scan level (low, medium, high)"
    secrets:
      DOCKER_REGISTRY_TOKEN:
        required: true
      SONAR_TOKEN:
        required: false
      CODECOV_TOKEN:
        required: false
      NPM_TOKEN:
        required: false
      SNYK_TOKEN:
        required: false

env:
  NODE_MODULES_CACHE_KEY: node-modules-${{ hashFiles('**/package-lock.json', '**/yarn.lock', '**/pnpm-lock.yaml') }}
  BUILD_CACHE_KEY: build-${{ github.workflow }}-${{ github.job }}

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: ${{ inputs.package-manager }}
          cache-dependency-path: ${{ inputs.working-directory }}/${{ inputs.package-manager == 'npm' && 'package-lock.json' || inputs.package-manager == 'yarn' && 'yarn.lock' || 'pnpm-lock.yaml' }}

      - name: Install dependencies
        run: |
          if [ "${{ inputs.package-manager }}" = "npm" ]; then
            npm ci
          elif [ "${{ inputs.package-manager }}" = "yarn" ]; then
            yarn install --frozen-lockfile
          else
            npx pnpm install --frozen-lockfile
          fi

      - name: Run linter
        run: |
          if [ "${{ inputs.package-manager }}" = "npm" ]; then
            npm run lint
          elif [ "${{ inputs.package-manager }}" = "yarn" ]; then
            yarn lint
          else
            npx pnpm lint
          fi

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: lint
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: ${{ inputs.package-manager }}
          cache-dependency-path: ${{ inputs.working-directory }}/${{ inputs.package-manager == 'npm' && 'package-lock.json' || inputs.package-manager == 'yarn' && 'yarn.lock' || 'pnpm-lock.yaml' }}

      - name: Install dependencies
        run: |
          if [ "${{ inputs.package-manager }}" = "npm" ]; then
            npm ci
          elif [ "${{ inputs.package-manager }}" = "yarn" ]; then
            yarn install --frozen-lockfile
          else
            npx pnpm install --frozen-lockfile
          fi

      - name: Run tests with coverage
        run: |
          if [ "${{ inputs.package-manager }}" = "npm" ]; then
            npm test -- --coverage
          elif [ "${{ inputs.package-manager }}" = "yarn" ]; then
            yarn test --coverage
          else
            npx pnpm test --coverage
          fi

      - name: Upload coverage to Codecov
        if: ${{ secrets.CODECOV_TOKEN != '' }}
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          directory: ${{ inputs.working-directory }}/coverage
          flags: ${{ inputs.service-name }}

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: test
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: ${{ inputs.package-manager }}
          cache-dependency-path: ${{ inputs.working-directory }}/${{ inputs.package-manager == 'npm' && 'package-lock.json' || inputs.package-manager == 'yarn' && 'yarn.lock' || 'pnpm-lock.yaml' }}

      - name: Install dependencies
        run: |
          if [ "${{ inputs.package-manager }}" = "npm" ]; then
            npm ci
          elif [ "${{ inputs.package-manager }}" = "yarn" ]; then
            yarn install --frozen-lockfile
          else
            npx pnpm install --frozen-lockfile
          fi

      - name: Build
        run: |
          if [ "${{ inputs.package-manager }}" = "npm" ]; then
            npm run build
          elif [ "${{ inputs.package-manager }}" = "yarn" ]; then
            yarn build
          else
            npx pnpm build
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: ${{ inputs.service-name }}-build
          path: |
            ${{ inputs.working-directory }}/build
            ${{ inputs.working-directory }}/dist
          retention-days: 7

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Snyk to check for vulnerabilities
        if: ${{ secrets.SNYK_TOKEN != '' }}
        uses: snyk/actions/node@master
        with:
          args: --severity-threshold=${{ inputs.security-scan-level }} ${{ inputs.working-directory }}
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

  e2e:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: security-scan
    if: ${{ inputs.run-e2e-tests }}
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: ${{ inputs.package-manager }}
          cache-dependency-path: ${{ inputs.working-directory }}/${{ inputs.package-manager == 'npm' && 'package-lock.json' || inputs.package-manager == 'yarn' && 'yarn.lock' || 'pnpm-lock.yaml' }}

      - name: Install dependencies
        run: |
          if [ "${{ inputs.package-manager }}" = "npm" ]; then
            npm ci
          elif [ "${{ inputs.package-manager }}" = "yarn" ]; then
            yarn install --frozen-lockfile
          else
            npx pnpm install --frozen-lockfile
          fi

      - name: Run E2E tests
        run: |
          if [ "${{ inputs.package-manager }}" = "npm" ]; then
            npm run test:e2e
          elif [ "${{ inputs.package-manager }}" = "yarn" ]; then
            yarn test:e2e
          else
            npx pnpm test:e2e
          fi

  docker:
    name: Docker Build & Push
    runs-on: ubuntu-latest
    needs: [security-scan, e2e]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/tags/')
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ inputs.service-name }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-${{ inputs.service-name }}-

      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.DOCKER_REGISTRY_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/phoenix/${{ inputs.service-name }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=sha,format=short
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ${{ inputs.working-directory }}
          file: ${{ inputs.working-directory }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max

      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: docker
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/tags/')
    strategy:
      matrix:
        environment: ${{ fromJson('[' + inputs.deploy-environments + ']') }}
    environment:
      name: ${{ matrix.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Deploy to ${{ matrix.environment }}
        run: |
          echo "Deploying ${{ inputs.service-name }} to ${{ matrix.environment }}"
          # Deployment commands would go here
          # For example:
          # helm upgrade --install ${{ inputs.service-name }} ./deployments/helm/${{ inputs.service-name }} \
          #   --namespace=${{ matrix.environment }} \
          #   --set image.tag=${{ github.sha }} \
          #   --wait
