# Phoenix Single-VM Deployment

This directory contains everything needed to deploy Phoenix on a single VM for organizations managing up to 200 hosts.

## Quick Start (< 30 minutes)

### 1. Prerequisites
- VM with 2+ vCPU, 4+ GB RAM, 30+ GB disk (t3.medium or equivalent)
- Ubuntu 20.04+ or RHEL 8+
- Docker and Docker Compose installed
- Domain pointing to VM (for HTTPS)
- Ports 80, 443, 8080, 9090, 9091 accessible

### 2. Deploy Control Plane

```bash
# Clone repository
git clone https://github.com/phoenix-observability/phoenix
cd phoenix/deployments/single-vm

# Run setup script
sudo ./scripts/setup-single-vm.sh
```

The script will:
- Generate secure credentials
- Setup TLS certificates (Let's Encrypt or self-signed)
- Initialize database
- Start all services
- Configure automated backups

### 3. Install Agents

On each edge node:
```bash
curl -fsSL https://phoenix.your-domain.com/install-agent.sh | sudo bash
```

## Architecture

```
┌─────────────────────────── Single VM ───────────────────────────┐
│                                                                  │
│  ┌─────────────┐  ┌──────────────┐  ┌─────────────┐           │
│  │  Phoenix    │  │  PostgreSQL  │  │ Prometheus  │           │
│  │  API + UI   │  │              │  │             │           │
│  │  Port 8080  │  │  Port 5432   │  │  Port 9090  │           │
│  └──────┬──────┘  └──────────────┘  └──────┬──────┘           │
│         │                                    │                   │
│         │         ┌──────────────┐          │                   │
│         │         │ Pushgateway  │◄─────────┘                   │
│         │         │  Port 9091   │                              │
│         │         └──────▲───────┘                              │
│         │                │                                       │
└─────────┼────────────────┼──────────────────────────────────────┘
          │                │
          │ Agent Poll     │ Metrics Push
          │ (Port 8080)    │ (Port 9091)
          │                │
     ┌────▼────┐      ┌────┴────┐      ┌─────────┐
     │ Agent   │      │ Agent   │      │ Agent   │
     │ Node 1  │      │ Node 2  │      │ Node N  │
     └─────────┘      └─────────┘      └─────────┘
```

## File Structure

```
single-vm/
├── docker-compose.yml      # Main deployment file
├── .env.template          # Environment variables template
├── config/
│   ├── prometheus.yml     # Prometheus configuration
│   └── grafana/          # Grafana dashboards
├── scripts/
│   ├── setup-single-vm.sh # One-command setup
│   ├── install-agent.sh   # Agent installer
│   ├── backup.sh         # Backup script
│   └── restore.sh        # Restore script
└── docs/
    ├── troubleshooting.md # Common issues
    └── workflows.md       # Usage examples
```

## Services

| Service | Purpose | Port | Access |
|---------|---------|------|--------|
| Phoenix API | REST + WebSocket | 8080 | Public |
| PostgreSQL | Data storage | 5432 | Internal only |
| Prometheus | Metrics storage | 9090 | Internal only |
| Pushgateway | Metrics ingestion | 9091 | Agents only |
| Grafana | Dashboards | 3000 | Optional public |

## Configuration

### Environment Variables (.env)
```bash
PHX_PUBLIC_URL=https://phoenix.your-domain.com
PHX_JWT_SECRET=<auto-generated>
POSTGRES_PASSWORD=<auto-generated>
PHX_PRICE_PER_SERIES=0.00011  # ₹ per metric/day
```

### TLS/SSL Options
1. **Let's Encrypt** (recommended): Automatic HTTPS with renewal
2. **Existing certificates**: Bring your own certs
3. **Self-signed**: For testing only
4. **HTTP only**: Not recommended

## Operations

### View Logs
```bash
cd /opt/phoenix
sudo docker-compose logs -f api
```

### Backup Data
```bash
sudo /opt/phoenix/scripts/backup.sh
```

### Update Phoenix
```bash
cd /opt/phoenix
sudo docker-compose pull
sudo docker-compose up -d
```

### Add Agents
```bash
# On new node:
curl -fsSL https://phoenix.your-domain.com/install-agent.sh | sudo bash
```

## Monitoring

- **Phoenix UI**: Real-time cost savings, agent status, experiments
- **Grafana**: Detailed metrics at `:3000` (optional)
- **Prometheus**: Query interface at `:9090` (internal)

## Security

- All agent communication over TLS
- JWT authentication for API
- Pushgateway restricted to agent IPs
- Database not exposed externally
- Automated security updates via OS

## Scaling

This single-VM setup handles:
- Up to 200 agents
- 500K metrics/second
- 10 concurrent experiments
- 70% cost reduction demonstrated

When you outgrow this:
1. Move PostgreSQL to RDS
2. Add Phoenix API replicas behind load balancer
3. Scale Prometheus horizontally

## Troubleshooting

### Agent Not Appearing
```bash
# On agent:
sudo journalctl -u phoenix-agent -f

# On VM:
sudo docker-compose logs api | grep agent
```

### High Memory Usage
```bash
# Check usage:
docker stats

# Increase limits in docker-compose.yml:
deploy:
  resources:
    limits:
      memory: 4G
```

### Certificate Issues
```bash
# Renew Let's Encrypt:
sudo certbot renew --force-renewal
sudo docker-compose restart api
```

## Support

- Documentation: [docs.phoenix-observability.io](https://docs.phoenix-observability.io)
- Issues: [github.com/phoenix-observability/phoenix/issues](https://github.com/phoenix-observability/phoenix/issues)
- Community: [discord.gg/phoenix-obs](https://discord.gg/phoenix-obs)

## License

Apache 2.0 - See LICENSE file